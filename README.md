![watchtower](https://drive.google.com/uc?export=view&id=1nN-FqxVmuYYOhPSGcWLwkDGQ9C080EaL)

![watchtower-web-server](https://drive.google.com/uc?export=view&id=1Y2xX1Vh3I7ipGXSOrkJB8uCKV6uYvAl9)

### Table of Contents
- [Introduction](#introduction)
- [Requirements](#requirements)
- [Installation](#installation)
- [Example Workflow](#example-workflow)
- [Configuration](#configuration)
- [Writing Modules](#writing-modules)
- [Web API](#web-api)
- [Future Considerations](#future-considerations)
- [Known Issues](#known-issues)
- [Powered By](#powered-by)
- [Author](#author)

### Introduction
This framework was designed to facilitate reconnaissance and attack surface management efforts.
Its primary purpose is to make trivial work of the following tasks:

1. **Automation**: Run any number of scripts with a single command.
2. **Parsing**: Get results into a SQLite database without having to deal with schemas.
3. **Organization**: Create individual workspaces for separate data.
4. **Searching**: Perform global searches via web interface.

There are four major components which make up the application:

1. **Modules**: Python scripts which fetch and parse files.  The responses they return get saved as...
2. **Cache Files**: After validating a module's response, the results are saved to a local cache file that
is then ready to be imported into...
3. **Databases**: SQLite3 databases are generated by watchtower upon request.  Once cache files have been imported into one or more databases, you can perform global searches on them using the...
4. **Web Server**: A Flask web application can be used to perform global searches across all columns in any database.

Although I had Information Security in mind when I created this, it can be used with any category of tools and data (no additional adaptation required).

```
watchtower
|
│   README.md           ; You're looking at it.
│   requirements.txt    ; Python package requirements for use with pip.
│   watchtower.conf     ; Configuration file for application settings and modules.
|   watchtower.log      ; Log file for the main application.
│   watchtower.py       ; Watchtower's main application.
│
└───cache               ; Cached output results from modules.
└───databases           ; SQLite3 databases.
└───modules             ; Python scripts which run tasks.
└───web                 ; Root directory for the Flask web application.
    |
    |   web.conf        ; Configuration file for the Flask web application.
    |   web.log         ; Log file for the Flask web application.
    |   web.py          ; Flask web application entry point.
    |
    └───static          ; Directory for static resources.
    |   |
    |   └───css         ; Cascading Style Sheet files.
    |   └───img         ; Image files.
    |   └───js          ; JavaScript files.
    |
    └───templates       ; Jinja HTML template files.
```

### Requirements
- Python 3.6+

##### Tested on
- Debian 10.4
- Ubuntu 20.04 LTS
- Windows 10 Pro 1909

### Installation
##### Debian/Ubuntu
```
# Install pip, gcc, and Python dependencies (reopen your terminal after to get the latest path and environment)
sudo apt update && sudo apt install python3-pip gcc python3-dev -y

# Clone the repository and change into project directory
git clone ...; cd watchtower

# Optional: Upgrade pip
pip3 install --upgrade pip

# Optional: Install venv
sudo apt install python3-venv

# Optional: Create a new venv
python3 -m venv venv

# Optional: Activate the venv
source venv/bin/activate

# Install package dependencies
pip3 install setuptools wheel

# Install watchtower packages
pip3 install -r requirements.txt

# Optional: Create the application symlink
sudo ln -sf "$(pwd)/watchtower.py" /usr/local/bin/watchtower

# Test the program
watchtower status

# or
python3 watchtower.py status
```

##### Windows
```
:: Clone the repository and change into project directory
git clone ... & cd watchtower

:: Optional: Upgrade pip (requires Administrator command prompt)
py -m pip install --upgrade pip

:: Optional: Install venv
py -m pip install --user virtualenv

:: Optional: Create a new venv
py -m venv venv

:: Optional: Activate the venv
.\venv\Scripts\activate

:: Install package dependencies
pip3 install setuptools wheel

:: Install watchtower packages
py -m pip install -r requirements.txt

:: Test the program (note: you must use python, not py)
python watchtower.py status
```

### Example Workflow
```
# Create a new database
watchtower db create

# Run the sample module with arguments
watchtower run -m sample -a hello -a goodbye

# Import the sample module's cache files into the new database
watchtower import -d watchtower -m sample

# Optional: Clear the sample module's cache files
watchtower cache clear -m sample

# Start the web server
watchtower web start

# Visit http://127.0.0.1:5000/ to search the data
```

### Configuration
There are two configuration files, both of which are based on [ConfigParser](https://docs.python.org/3.8/library/configparser.html):

1. `watchtower.conf`: Handles the watchtower application's behavior.
The first section in this file is the `[default]` section.  Do not edit this section manually; it is modified automatically before every run of the application to fit your environment.

Beyond that, every other section is a module.  Declaring a module as a section will "activate" it by making it visible to the application.

```
[sample]
description = Sample module for demo purposes.
password = 12345
```

Note that the key-value pairs below the section header can be retrieved by the module at run time.  This is useful for storing secrets or static values.

2. `web.conf`: Handles the table and column visibility on the web server.

This configuration file can be left completely blank if you just want to display all tables and columns
for all databases as they are.  Otherwise, you can display specific databases, tables, and columns like so:

```
[watchtower]
devices = hostname,ip
services = ip,port,protocol,banner
imports =
```

In the example above, `[watchtower]` is the name of the database, while `devices`, `services`, and `imports` are tables.  The `devices` and `services` table will only display the comma-separated columns that are listed, while the `imports` table will display all of its columns.  Each table and column will be displayed in the order that it has been declared.

If you just specify the database as a section without any tables or columns listed below it,
then none of its tables or columns will be displayed.  Worded differently; once you declare a
database as a section in the configuration, you have to be explicit about which tables and columns
you'd like to display.

After making any changes to this configuration file, restart the web server for the changes
to take effect.

### Writing Modules
After declaring a module in `watchtower.conf`, the application will expect
an equivalently-named Python script to exist in the `modules` directory.

```
watchtower
|
└───modules
    |
    |   sample.py
    |   ...
```

In order for this module to be compliant with the framework, it must do the following:

1. Import `WatchtowerModule` from `watchtower`.
2. Have a class which subclasses `WatchtowerModule` (the name of the class doesn't matter).
3. The above class must have a method called `run` which accepts exactly two parameters: `self` and `args`.
4. Its `run` method must return a properly-formatted response (see: **Module Responses** subsection below).

```
#!/usr/bin/env python3

from watchtower import WatchtowerModule


class SampleModule(WatchtowerModule):
    def run(self, args):
      ...
```

Beyond that, anything else is fair game; you can perform any operation inside of your
`run` method as long as it returns a compliant response.

If you would like to retrieve one of your key-value pairs from the configuration file,
you can do so by using the following helper method:

```
password = self.get_config_value("password")
```

Additionally, arguments passed to the module during runtime can be accessed via the `args` parameter:

```
first_arg = args[0]
second_arg = args[1]
```

##### Advice on writing good modules
- **No heavy lifting**.  This framework was written with the philosophy that these modules should not perform the heavy lifting for any given task.  If you have to run a command which is expensive or takes a long time to complete, do that outside of the module; your module should only focus on parsing the results.

- **Don't touch the database**.  While you _can_ directly access a database from within a module, you shouldn't.  The flow of this framework was designed to operate in one direction: Module → Cache File → Database → Web Server.  If you feel the need to query a database from within your module, consider an alternative solution to your problem.

##### Module Responses
The return value of a module must meet a specific format, best demonstrated by example:

```
response = {
            "tables": {
                "devices": {
                    "rows": [
                        {"mac": "6F:30:7D:44:12:01", "hostname": "linux-server-1", "ip": "10.0.0.1"}
                        ...
                    ],
                    "pk": "mac"
                },
                "services": {
                    "rows": [
                        {"ip": "10.0.0.1", "port": 21, "protocol": "tcp", "banner": "ProFTPD 1.3.6d Server"}
                        ...
                    ]
                }
            }
        }
```

In the example above, two tables are being defined: `devices` and `services`.

> You cannot specify a table named `imports`, as this name is reserved for use by the application.

The primary key for each table can be specified by using the `pk` key.
- If `pk` is not specified, a primary key will not be created.
- If `pk` is specified, but refers to a column name that **does not** exist in your rows, the specified column will be created automatically.
- If `pk` is specified, and refers to a column name that **does** exist in your rows, that row will be set as the primary key.

The primary key will be used to determine if a new row should be inserted into the database, or an existing row should be overwritten.

Within the `rows` of your response, you can specify a list of key-value pairs which represent your data rows; the keys represent the column names, while the values represent the data.  The column order in the database will be the same order in which your keys are declared.

> The column name `import_id` is reserved for use by the application; if you attempt to use it, your data will automatically be overwritten.

If you are importing into a table which already exists, any new columns specified will be created automatically.

Note that at the time of this writing, it is not yet possible to specify foreign keys or many-to-many relationships.

##### Acceptable data types
- `str`
- `int`
- `bool`
- `list`
- `dict`
- `datetime.date`
- `datetime.datetime`

##### Sample Module
A sample module which bears likeness to the notes in this documentation has been provided and can be found in `modules/sample.py`.

### Web API
Although the API was created primarily for use with [DataTables](https://datatables.net/) and has only been tested in that context, you may still find it helpful.

##### Search a table in a database
- `/api/v1/global-search/search` (accepts: `GET`/`POST`)
    - `database`: Name of the database you want to search (required).
    - `table`: Name of the table you want to search (required).
    - `query`: Query keywords or phrases to search for (separate keywords with commas, spaces, or newlines, join phrases with double quotes) (default: `None`).
    - `order`: Column index number by which to order the results (default: `1`).
    - `direction`: Direction to order the results (default: `ASC`).
    - `length`: Maximum number of results to return (default: `10`).
    - `start`: Number by which to offset the results (default: `0`).

##### Download a database
- `/api/v1/database/download` (accepts: `GET`/`POST`)
    - `database`: Name of the database you want to download (required).

### Future Considerations
- Module support for:
    - Foreign Keys
    - Many-to-Many relationships
    - Composite Primary Keys
    - Composite Indexes
- A robust JSON API (proper error handling, granular requests, etc.)
- Swagger Documentation

### Known Issues
- If you name a module "test", it won't run correctly.  I believe it's a namespace collision issue.
- The Web UI is only responsive to a degree before the layout begins to overflow itself.


### Powered By
- [Flask](https://flask.palletsprojects.com/en/1.1.x/)
- [Jinja](https://jinja.palletsprojects.com/en/2.11.x/)
- [Semantic UI](https://semantic-ui.com/)
- [jQuery](https://jquery.com/)
- [DataTables](https://datatables.net/)
- [sqlite-utils](https://sqlite-utils.readthedocs.io/en/stable/)

##### Python Dependencies
```
click
click-default-group
colored
filelock
itsdangerous
MarkupSafe
psutil
python-dateutil
python-interface
six
tabulate
Werkzeug
```

##### JavaScript Dependencies
```
jquery-tripleclick
moment
moment-timezone
pdfmake
```
### Author
- Justin Bacco
